<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"  href="style.css" />

    <title>Document</title>
</head>

<body>
    <main>
        <div id="count"></div>
        <object id="obj-bot-svg" type="image/svg+xml" data="botfull.svg"></object>
    </main>
</body>

<script type="text/javascript">
/////////////////////////////////////////////
//SVG MANIPUTLATION
const svg = document.getElementById("obj-bot-svg");
var pupilsElts = [];

svg.addEventListener("load", function() {
    var fullSvg = svg.contentDocument;
    var botLayers = ["slash", "box", "parts", "face"];

    //link event awake bot on clic
    botLayers.forEach(function(elt) {
        let current = fullSvg.getElementById(elt);
        // current.addEventListener("click", awakeTheBot); 
        current.addEventListener("click", function(e) {
            clickOnBot(); 
            e.stopPropagation();

        });
    })
    // let botLayersElts = [];

    var pupils = [
        "pup_x5F_l_x5F_norm", "pup_x5F_r_x5F_norm", "pup_x5F_l_x5F_happy", "pup_x5F_r_x5F_happy", "pup_x5F_l_x5F_sleep", "pup_x5F_r_x5F_sleep", "pup_x5F_l_x5F_angry", "pup_x5F_r_x5F_angry"
    ];

    pupils.forEach(function(elt) {
        let current = fullSvg.getElementById(elt);
        pupilsElts.push(current);
    })
    pupilDisplayOnly("sleep");
})

/////////////////////////////////////////////
//TIMER
let counter = document.querySelector("#count");
let time, secondes = 0;

function startTime() { 
    counter.textContent = secondes;
    secondes++; 

    if(secondes >= 10) {
        let state = getState();
        if(state == "angry") {
            botReturnToNormal();
            resetTime();
        }
        else if(state == "norm") {
            botReturnToSleep();
            stopTime();
        }
    }
} 

function stopTime() {
	clearInterval(time); 
	secondes = 0; 
    counter.textContent = secondes;
}

function resetTime() {
    stopTime();
	time = setInterval(startTime, 1000);  
}
window.onload = resetTime;
window.ontouchstart = resetTime; 
window.onclick = resetTime; 
window.onkeypress = resetTime;
window.onmousemove = resetTime; 
window.onmousedown = resetTime;  

/////////////////////////////////////////////
//FUNCTION
function getState() {
    let actuallyDisplayed = whichPupAreDisplay();
    let arr = actuallyDisplayed[0].id.split("_");

    console.log("get state", arr[arr.length - 1]);
    return arr[arr.length - 1];
}

function whichPupAreDisplay() {
    let areDisplay = [];
    pupilsElts.forEach(path => {
        if(window.getComputedStyle(path).display != "none") {
            areDisplay.push(path);
        }
    })
    // console.log(areDisplay);
    return areDisplay;
}

function pupilDisplayOnly(str) {
    console.log("display only " + str);
    pupilsElts.forEach(pup => {
        if(!pup.id.includes(str)) {
            pup.style.display = "none";
        }
        else {
            pup.style.display = "inline";
            console.log(pup.id, window.getComputedStyle(pup).display);
        }
    })
}


function angerTheBot() {
    console.log("anger");
    pupilDisplayOnly("angry");
    // botReturnToNormal();
}

function awakeTheBot() {
    console.log("awake");
    pupilDisplayOnly("norm");
    // botReturnToSleep();
}

function furyTheBot() {
    console.log("fury");
    let displayed = whichPupAreDisplay();

    if(displayed[0].id.includes("angry")) {
        displayed.forEach(path => {
        redEyes(path);
    })
    }
}

function botReturnToNormal() {
        console.log("return to normal");
        pupilDisplayOnly("norm");

        whichPupAreDisplay().forEach(path => {
            normColorEyes(path);
        })
}

function botReturnToSleep() {
        console.log("return to sleep");
        pupilDisplayOnly("sleep");
}


function clickOnBot() {
    console.log("clic");

    let state = getState();
    if(state == "sleep") {
        awakeTheBot();
    }
    else if(state == "angry") {
        furyTheBot();
    }
    else if(state = "norm") {
        angerTheBot();
    }
}



function redEyes(path) {
    console.log("red");
        path.style.fill = "#ff0000";
        path.style.transition = "fill 2s ease";
    }

function normColorEyes(path) {
    console.log("normal eyes color");

        path.style.fill = "#414042";
        path.style.transition = "fill 4s ease";
    }

</script>
</html>